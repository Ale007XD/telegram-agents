from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

# --- –ú–ï–¢–ê–î–ê–ù–ù–´–ï –î–õ–Ø –ê–í–¢–û-–ú–ï–ù–Æ ---
# –ë–æ—Ç —Å—á–∏—Ç–∞–µ—Ç —ç—Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏ –¥–æ–±–∞–≤–∏—Ç –∫–Ω–æ–ø–∫—É –≤ /start
SKILL_METADATA = {
    "name": "taro",
    "desc": "üîÆ –®–∫–æ–ª–∞ –¢–∞—Ä–æ",
    "command": "/taro"
}

router = Router()

# --- –ö–û–ù–¢–ï–ù–¢ –ö–£–†–°–ê ---
COURSE_DATA = {
    "intro": {
        "title": "üë∂ –í–≤–µ–¥–µ–Ω–∏–µ (–£—Ä–æ–∫–∏ 1-6)",
        "lessons": [
            "üìú <b>–£—Ä–æ–∫ 1: –í–≤–µ–¥–µ–Ω–∏–µ –≤ –¢–∞—Ä–æ</b>\n\n–¢–∞—Ä–æ ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–∞–º–æ–ø–æ–∑–Ω–∞–Ω–∏—è. –ö–æ–ª–æ–¥–∞ –†–∞–π–¥–µ—Ä–∞-–£–∞–π—Ç–∞ (1910) ‚Äî —ç—Ç–∞–ª–æ–Ω–Ω–∞—è.\n\n<b>–ó–∞–¥–∞–Ω–∏–µ:</b> –ö—É–ø–∏—Ç–µ –∫–æ–ª–æ–¥—É –∏–ª–∏ —Å–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.",
            "üÉè <b>–£—Ä–æ–∫ 2: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–ª–æ–¥—ã</b>\n\n–í—Å–µ–≥–æ 78 –∫–∞—Ä—Ç:\n‚Ä¢ <b>22 –°—Ç–∞—Ä—à–∏—Ö –ê—Ä–∫–∞–Ω–∞</b>: –í–µ–ª–∏–∫–∏–µ –∞—Ä—Ö–µ—Ç–∏–ø—ã.\n‚Ä¢ <b>56 –ú–ª–∞–¥—à–∏—Ö –ê—Ä–∫–∞–Ω–æ–≤</b>: –ë—ã—Ç–æ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏.",
            "üé® <b>–£—Ä–æ–∫ 3: –°–∏–º–≤–æ–ª–∏–∫–∞</b>\n\n–¶–≤–µ—Ç–∞:\n‚Ä¢ –ñ–µ–ª—Ç—ã–π ‚Äî —ç–Ω–µ—Ä–≥–∏—è.\n‚Ä¢ –°–∏–Ω–∏–π ‚Äî —ç–º–æ—Ü–∏–∏.\n‚Ä¢ –ö—Ä–∞—Å–Ω—ã–π ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ.",
            "üõ°Ô∏è <b>–£—Ä–æ–∫ 4: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞</b>\n\n1. –û—á–∏—Å—Ç–∏—Ç–µ –º–µ—Å—Ç–æ.\n2. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ—Å—å.\n3. –ü–µ—Ä–µ—Ç–∞—Å—É–π—Ç–µ –∫–æ–ª–æ–¥—É, –¥—É–º–∞—è –æ –≤–æ–ø—Ä–æ—Å–µ.",
            "üìñ <b>–£—Ä–æ–∫ 5: –ü—Ä–∏–Ω—Ü–∏–ø—ã</b>\n\n–ù–µ –∑—É–±—Ä–∏—Ç—å! –°–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É. –ß—Ç–æ –≤—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ? –≠—Ç–æ –≤–∞–∂–Ω–µ–µ –∫–Ω–∏–∂–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.",
            "üß© <b>–£—Ä–æ–∫ 6: –ö–∞—Ä—Ç–∞ –¥–Ω—è</b>\n\n–£—Ç—Ä–æ–º –≤—ã—Ç—è–Ω–∏—Ç–µ 1 –∫–∞—Ä—Ç—É. –í–µ—á–µ—Ä–æ–º —Å—Ä–∞–≤–Ω–∏—Ç–µ —Å –ø—Ä–æ—à–µ–¥—à–∏–º –¥–Ω–µ–º."
        ]
    },
    "minor_courts": {
        "title": "ü§¥ –ü—Ä–∏–¥–≤–æ—Ä–Ω—ã–µ –∫–∞—Ä—Ç—ã",
        "lessons": [
            "üî• <b>–£—Ä–æ–∫ 7: –ö–æ—Ä–æ–ª–∏ –∏ –†—ã—Ü–∞—Ä–∏</b>\n\n–ñ–µ–∑–ª—ã: –õ–∏–¥–µ—Ä. –ö—É–±–∫–∏: –≠–º–ø–∞—Ç. –ú–µ—á–∏: –ê–Ω–∞–ª–∏—Ç–∏–∫. –ü–µ–Ω—Ç–∞–∫–ª–∏: –ë–∏–∑–Ω–µ—Å–º–µ–Ω.",
            "üë∂ <b>–£—Ä–æ–∫ 8: –ü–∞–∂–∏</b>\n\n–í–µ—Å—Ç–Ω–∏–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π, –¥–µ—Ç–∏, —à–∞–Ω—Å—ã.",
            "üé≠ <b>–£—Ä–æ–∫ 9: –†–æ–ª–µ–≤—ã–µ –∏–≥—Ä—ã</b>\n\n–ü—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ –∑–Ω–∞–∫–æ–º—ã—Ö –≤ —Ä–æ–ª—è—Ö –ü–∞–∂–µ–π –∏–ª–∏ –ö–æ—Ä–æ–ª–µ–π.",
            "üÉè <b>–£—Ä–æ–∫ 10: –†–∞—Å–∫–ª–∞–¥</b>\n\n'–ö–∞–∫ –º–µ–Ω—è –≤–∏–¥—è—Ç?' –í—ã—Ç—è–Ω–∏—Ç–µ 1 –∫–∞—Ä—Ç—É."
        ]
    },
    "minor_pips": {
        "title": "üî¢ –ß–∏—Å–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã",
        "lessons": [
            "1Ô∏è‚É£ <b>–£—Ä–æ–∫ 11: –¢—É–∑—ã –∏ –î–≤–æ–π–∫–∏</b>\n\n–¢—É–∑—ã ‚Äî –∏–º–ø—É–ª—å—Å. –î–≤–æ–π–∫–∏ ‚Äî –≤—ã–±–æ—Ä.",
            "3Ô∏è‚É£ <b>–£—Ä–æ–∫ 12: –¢—Ä–æ–π–∫–∏ - –°–µ–º–µ—Ä–∫–∏</b>\n\n3: –†–æ—Å—Ç. 4: –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å. 5: –ö—Ä–∏–∑–∏—Å. 6: –ü–æ–º–æ—â—å. 7: –•–∏—Ç—Ä–æ—Å—Ç—å.",
            "8Ô∏è‚É£ <b>–£—Ä–æ–∫ 13: 8 - 10</b>\n\n8: –î–≤–∏–∂–µ–Ω–∏–µ/—Ç—É–ø–∏–∫. 9: –û–¥–∏–Ω–æ—á–µ—Å—Ç–≤–æ/—Ä–∞–¥–æ—Å—Ç—å. 10: –ò—Ç–æ–≥.",
            "üÉè <b>–£—Ä–æ–∫ 14: –ü—Ä–∞–∫—Ç–∏–∫–∞</b>\n\n–í–æ–ø—Ä–æ—Å '–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ä–∞–±–æ—Ç–µ?' (3 –∫–∞—Ä—Ç—ã)."
        ]
    },
    "royals": {
        "title": "üëë –ö–æ—Ä–æ–ª–µ–≤—ã",
        "lessons": [
            "üë∏ <b>–£—Ä–æ–∫ 15: –ö–æ—Ä–æ–ª–µ–≤—ã</b>\n\n–ñ–µ–∑–ª—ã: –•–∞—Ä–∏–∑–º–∞. –ö—É–±–∫–∏: –ß—É–≤—Å—Ç–≤–∞. –ú–µ—á–∏: –£–º. –ü–µ–Ω—Ç–∞–∫–ª–∏: –•–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å.",
            "üß© <b>–£—Ä–æ–∫ 16: –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ</b>\n\n–ö—Ç–æ –∏–∑ –ö–æ—Ä–æ–ª–µ–≤ –ø–æ—Ö–æ–∂ –Ω–∞ –≤–∞—Å?"
        ]
    },
    "major_1": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã I",
        "lessons": [
            "0Ô∏è‚É£ <b>–£—Ä–æ–∫ 17: –®—É—Ç –∏ –ú–∞–≥</b>\n\n0 –®—É—Ç: –°–≤–æ–±–æ–¥–∞, —Ä–∏—Å–∫. I –ú–∞–≥: –í–æ–ª—è, —Ä–µ—Å—É—Ä—Å—ã.",
            "2Ô∏è‚É£ <b>–£—Ä–æ–∫ 18: –ñ—Ä–∏—Ü–∞ –∏ –ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞</b>\n\nII –ñ—Ä–∏—Ü–∞: –¢–∞–π–Ω–∞. III –ò–º–ø–µ—Ä–∞—Ç—Ä–∏—Ü–∞: –†–æ—Å—Ç.",
            "4Ô∏è‚É£ <b>–£—Ä–æ–∫ 19: –ò–º–ø–µ—Ä–∞—Ç–æ—Ä –∏ –ò–µ—Ä–æ—Ñ–∞–Ω—Ç</b>\n\nIV –ò–º–ø–µ—Ä–∞—Ç–æ—Ä: –í–ª–∞—Å—Ç—å. V –ò–µ—Ä–æ—Ñ–∞–Ω—Ç: –¢—Ä–∞–¥–∏—Ü–∏–∏.",
            "üÉè <b>–£—Ä–æ–∫ 20: –ê—Ä—Ö–µ—Ç–∏–ø—ã</b>\n\n–ö–∞–∫–æ–π –ê—Ä–∫–∞–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç –≤–∞—Å —Å–µ–π—á–∞—Å?"
        ]
    },
    "major_2": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã II",
        "lessons": [
            "6Ô∏è‚É£ <b>–£—Ä–æ–∫ 21: –í–ª—é–±–ª–µ–Ω–Ω—ã–µ –∏ –ö–æ–ª–µ—Å–Ω–∏—Ü–∞</b>\n\nVI: –í—ã–±–æ—Ä. VII: –ü–æ–±–µ–¥–∞.",
            "8Ô∏è‚É£ <b>–£—Ä–æ–∫ 22: –°–∏–ª–∞ –∏ –û—Ç—à–µ–ª—å–Ω–∏–∫</b>\n\nVIII: –ú—è–≥–∫–∞—è —Å–∏–ª–∞. IX: –ú—É–¥—Ä–æ—Å—Ç—å.",
            "üîü <b>–£—Ä–æ–∫ 23: –ö–æ–ª–µ—Å–æ –∏ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å</b>\n\nX: –°—É–¥—å–±–∞. XI: –ö–∞—Ä–º–∞.",
            "üÉè <b>–£—Ä–æ–∫ 24: –ü—Ä–∞–∫—Ç–∏–∫–∞</b>\n\n–ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –∫–∞—Ä—Ç—É '–°–∏–ª–∞'."
        ]
    },
    "major_3": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã III",
        "lessons": [
            "1Ô∏è‚É£2Ô∏è‚É£ <b>–£—Ä–æ–∫ 25: –ü–æ–≤–µ—à–µ–Ω–Ω—ã–π –∏ –°–º–µ—Ä—Ç—å</b>\n\nXII: –ñ–µ—Ä—Ç–≤–∞. XIII: –ü–µ—Ä–µ–º–µ–Ω—ã.",
            "1Ô∏è‚É£4Ô∏è‚É£ <b>–£—Ä–æ–∫ 26: –£–º–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –∏ –î—å—è–≤–æ–ª</b>\n\nXIV: –ë–∞–ª–∞–Ω—Å. XV: –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å.",
            "1Ô∏è‚É£6Ô∏è‚É£ <b>–£—Ä–æ–∫ 27: –ë–∞—à–Ω—è –∏ –ó–≤–µ–∑–¥–∞</b>\n\nXVI: –ö—Ä–∞—Ö. XVII: –ù–∞–¥–µ–∂–¥–∞.",
            "üÉè <b>–£—Ä–æ–∫ 28: –°—Ç—Ä–∞—Ö–∏</b>\n\n–†–∞—Å–∫–ª–∞–¥ '–ß–µ–≥–æ —è –±–æ—é—Å—å?'"
        ]
    },
    "major_4": {
        "title": "üåü –°—Ç–∞—Ä—à–∏–µ –ê—Ä–∫–∞–Ω—ã IV",
        "lessons": [
            "1Ô∏è‚É£8Ô∏è‚É£ <b>–£—Ä–æ–∫ 29: –õ—É–Ω–∞ –∏ –°–æ–ª–Ω—Ü–µ</b>\n\nXVIII: –ò–ª–ª—é–∑–∏–∏. XIX: –Ø—Å–Ω–æ—Å—Ç—å.",
            "2Ô∏è‚É£0Ô∏è‚É£ <b>–£—Ä–æ–∫ 30: –°—É–¥ –∏ –ú–∏—Ä</b>\n\nXX: –í–æ–∑—Ä–æ–∂–¥–µ–Ω–∏–µ. XXI: –§–∏–Ω–∞–ª."
        ]
    },
    "spreads": {
        "title": "üÉè –†–∞—Å–∫–ª–∞–¥—ã",
        "lessons": [
            "3Ô∏è‚É£ <b>–£—Ä–æ–∫ 31: –¢—Ä–∏ –∫–∞—Ä—Ç—ã</b>\n\n–ü—Ä–æ—à–ª–æ–µ - –ù–∞—Å—Ç–æ—è—â–µ–µ - –ë—É–¥—É—â–µ–µ.",
            "‚ùå <b>–£—Ä–æ–∫ 32: –ö—Ä–µ—Å—Ç</b>\n\n–ü—Ä–æ–±–ª–µ–º–∞, –ß—Ç–æ –Ω–µ –¥–µ–ª–∞—Ç—å, –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –ò—Ç–æ–≥.",
            "üí° <b>–£—Ä–æ–∫ 33: –í—ã–±–æ—Ä</b>\n\n–î–≤–∞ –ø—É—Ç–∏ —Ä–∞–∑–≤–∏—Ç–∏—è —Å–∏—Ç—É–∞—Ü–∏–∏.",
            "üçÄ <b>–£—Ä–æ–∫ 41: –ö–µ–ª—å—Ç—Å–∫–∏–π –ö—Ä–µ—Å—Ç</b>\n\n–ì–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ (10 –∫–∞—Ä—Ç)."
        ]
    },
    "final": {
        "title": "üéì –§–∏–Ω–∞–ª",
        "lessons": [
            "üß© <b>–£—Ä–æ–∫ 46: –°–∏–Ω—Ç–µ–∑</b>\n\n–ß–∏—Ç–∞–π—Ç–µ –∫–∞—Ä—Ç—ã –≤–º–µ—Å—Ç–µ, –∞ –Ω–µ –ø–æ –æ–¥–Ω–æ–π.",
            "üßò <b>–£—Ä–æ–∫ 47: –ò–Ω—Ç—É–∏—Ü–∏—è</b>\n\n–î–æ–≤–µ—Ä—è–π—Ç–µ –ø–µ—Ä–≤–æ–º—É —á—É–≤—Å—Ç–≤—É.",
            "üö´ <b>–£—Ä–æ–∫ 48: –≠—Ç–∏–∫–∞</b>\n\n–ù–µ –ø—É–≥–∞–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤.",
            "üéâ <b>–£—Ä–æ–∫ 50: –í—ã–ø—É—Å–∫–Ω–æ–π</b>\n\n–ü—Ä–∞–∫—Ç–∏–∫–∞ - –∫–ª—é—á –∫ –º–∞—Å—Ç–µ—Ä—Å—Ç–≤—É!"
        ]
    }
}

# --- –ö–õ–ê–í–ò–ê–¢–£–†–´ ---
def get_main_menu():
    builder = InlineKeyboardBuilder()
    buttons = [
        ("üë∂ –í–≤–µ–¥–µ–Ω–∏–µ", "module_intro"),
        ("ü§¥ –ü—Ä–∏–¥–≤–æ—Ä–Ω—ã–µ", "module_minor_courts"),
        ("üî¢ –ß–∏—Å–ª–æ–≤—ã–µ", "module_minor_pips"),
        ("üëë –ö–æ—Ä–æ–ª–µ–≤—ã", "module_royals"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 1", "module_major_1"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 2", "module_major_2"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 3", "module_major_3"),
        ("üåü –°–ê –ß–∞—Å—Ç—å 4", "module_major_4"),
        ("üÉè –†–∞—Å–∫–ª–∞–¥—ã", "module_spreads"),
        ("üéì –§–∏–Ω–∞–ª", "module_final"),
    ]
    for text, cb in buttons:
        builder.button(text=text, callback_data=cb)
    builder.adjust(2)
    return builder.as_markup()

def get_lesson_nav(module_key, idx, total):
    builder = InlineKeyboardBuilder()
    if idx > 0:
        builder.button(text="‚¨ÖÔ∏è", callback_data=f"nav_{module_key}_{idx-1}")
    if idx < total - 1:
        builder.button(text="‚û°Ô∏è", callback_data=f"nav_{module_key}_{idx+1}")
    
    builder.button(text="üîù –ú–µ–Ω—é", callback_data="taro_menu")
    
    if idx > 0 and idx < total - 1:
        builder.adjust(2, 1)
    else:
        builder.adjust(1, 1)
    return builder.as_markup()

# --- –•–ï–ù–î–õ–ï–†–´ ---

@router.message(Command("taro"))
async def start_taro(message: types.Message):
    await message.answer(
        "üîÆ <b>–®–∫–æ–ª–∞ –¢–∞—Ä–æ</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –æ–±—É—á–µ–Ω–∏—è:",
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )

@router.callback_query(F.data == "taro_menu")
async def back_to_menu(callback: types.CallbackQuery):
    await callback.message.edit_text(
        "üîÆ <b>–®–∫–æ–ª–∞ –¢–∞—Ä–æ</b>\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:",
        reply_markup=get_main_menu(),
        parse_mode="HTML"
    )

@router.callback_query(F.data.startswith("module_"))
async def open_module(callback: types.CallbackQuery):
    try:
        module_key = callback.data.split("_", 1)[1]
        await show_lesson(callback, module_key, 0)
    except:
        await callback.answer("–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥—É–ª—è")

@router.callback_query(F.data.startswith("nav_"))
async def navigate_lesson(callback: types.CallbackQuery):
    try:
        parts = callback.data.split("_")
        idx = int(parts[-1])
        module_key = "_".join(parts[1:-1])
        await show_lesson(callback, module_key, idx)
    except:
        await callback.answer("–û—à–∏–±–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏")

async def show_lesson(callback: types.CallbackQuery, module_key, idx):
    data = COURSE_DATA.get(module_key)
    if not data: return
    
    lessons = data["lessons"]
    total = len(lessons)
    text = f"<b>{data['title']}</b> ({idx+1}/{total})\n\n{lessons[idx]}"
    
    try:
        await callback.message.edit_text(
            text,
            reply_markup=get_lesson_nav(module_key, idx, total),
            parse_mode="HTML",
            disable_web_page_preview=True
        )
    except Exception:
        await callback.answer()

def setup():
    return router
